<!DOCTYPE html>
<html>
<head>
	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon"> 
	<title>NodeWars SuperMegaAlpha</title>
	<script src="libs/d3.js"></script>
	<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
	<script src="libs/jquery.terminal/js/jquery-1.7.1.min.js"></script>
    <script src="libs/jquery.terminal/js/jquery.terminal.min.js"></script>
    <script src="https://unpkg.com/split.js/split.min.js"></script>
    <link href="libs/jquery.terminal/css/jquery.terminal.css" rel="stylesheet"/>
    <script src="libs/ace-builds/src/ace.js" type="text/javascript" charset="utf-8">
</script>

  <style>
  
	body {
		overflow-y: hidden
	}

	textarea {
		resize:none;

		border: none;
	    overflow: auto;
	    outline: none;

	    -webkit-box-shadow: none;
	    -moz-box-shadow: none;
	    box-shadow: none;
	}
	
	#main-col {
		position:absolute;
		top:0;
		bottom:0;
		left:0;
		right:0;

		display: flex;
		flex-direction: column;
		flex-wrap: nowrap;
	}

	#main-row {
		display: flex;
		flex-direction: row;
		flex-wrap: nowrap;
		height:100%;
	}
	
	#world-col {
		position: relative;
		display:flex;
		width:50%;
		flex-direction: column;
	}

	#team-flag {
		z-index: 10;
		opacity: 1;
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		/*bottom: 8px;*/
		width:100%;
		height:10px;
		background-color: black;
	}

	#terminal {
		width: 100%;
		height: 100%;
	}

	#graph {
		/*order:0;*/
		/*flex-grow:1;*/
		background-color: beige;
		overflow-y: hidden;
	}

	.gutter {
		background-color: grey;
		cursor: row-resize;
		height:1px;
	}

	
	#code-col {
		/*order:1;*/
		/*flex-grow:2;*/
		/*background-color: lightgrey;*/
		position: relative;
		display:flex;
		width:50%;
		flex-direction: column;
	}

	#stdin {
		padding: 3px;
		z-index: 9;
		position:absolute;
		background-color: white;
		top:0;
		right:0;
		width:110px;
		height:50px;
		border-left: 1px solid black;
		border-bottom: 1px solid black;

	}

	#editor {
		/*height:80%;*/
		width:100%;
		background-color: lightgrey;
	}

	#output {
		padding:5px;
		width:100%;
		height:20%;
		background-color: white;
		white-space: pre;
		overflow-y: scroll;
	}

	.terminal, .cmd, .terminal .terminal-output div div, .cmd .prompt {
	    font-size: 18px;
	    line-height: 22px;
	}

	/*map styling*/

	.node-main, .node-backing {
		stroke: black;
		stroke-width: 2;
		fill: white
	}

	.traffic {
  		stroke-width:3;
  	}

  	.player-connected {
  		stroke-width:6;
  	}

  	.node-poe{
	  animation-duration: 1.3s;
	  animation-name: glowPulse;
	  animation-iteration-count: infinite;
	  animation-direction: alternate;
	  -webkit-animation-timing-function: linear; /* Safari 4.0 - 8.0 */
      animation-timing-function: linear;
	}
  	

  	line.traffic {
  		stroke-width:4;
  	}

	@keyframes glowPulse {
	  from {
	  	fill-opacity:.4;
	    /*fill-opacity:1;*/
	  }

	  to {
	  	fill-opacity:.8;
	  }
}

  </style>
</head>
<body>
<div id="main-col">
	
	<div id="main-row">
		<div id="world-col">
			<div id="team-flag"></div>
			<div id="terminal"></div>
			<div id="graph"></div>
		</div>

		<div id="code-col">
			<textarea id="stdin"></textarea>
			<div id="editor"></div>
			<div id="output">The results of your executed code will appear here</div>
		</div>
	</div>
</div>

<script src="d3app.js"></script>

<script>
'use strict';
// on document ready jquery shorthand
// $(function () {
	

	// Initialize our boxes
	const startStdin = "Use this box for custom stdin"
	$("#stdin").val(startStdin)
	$("#stdin").click(()=>{
		if ($("#stdin").val()==startStdin){
			$("#stdin").val("")
		}
	})

	// graphViz must be declared before split called as split calls GV's resize
	const graphViz = new NWGraph('#graph')

	// Split(['#world-col', '#code-col'], {
	// 	direction: 'vertical',
	// 	sizes: [50, 50],
	//     elementStyle: function (dimension, size, gutterSize) {
	//     	graphViz.resize()
	//         return {
	//             'flex-basis': 'calc(' + size + '% - ' + gutterSize + 'px)'
	//         }
	//     },
	//     gutterStyle: function (dimension, gutterSize) {
	//     	graphViz.resize()
	//         return {
	//             'flex-basis':  gutterSize + 'px'
	//         }
	//     }
	// })

	Split(['#terminal', '#graph'], {
		direction: 'vertical',
		sizes: [35, 65],
	    elementStyle: function (dimension, size, gutterSize) {
	    	graphViz.resize()
	        return {
	            'flex-basis': 'calc(' + size + '% - ' + gutterSize + 'px)'
	        }
	    },
	    gutterStyle: function (dimension, gutterSize) {
	    	graphViz.resize()
	        return {
	            'flex-basis':  gutterSize + 'px'
	        }
	    }
	})

	Split(['#editor', '#output'], {
		direction: 'vertical',
		sizes: [80, 20],
	    elementStyle: function (dimension, size, gutterSize) {
	        return {
	            'flex-basis': 'calc(' + size + '% - ' + gutterSize + 'px)'
	        }
	    },
	    gutterStyle: function (dimension, gutterSize) {
	        return {
	            'flex-basis':  gutterSize + 'px'
	        }
	    }
	})

	$(document).keypress(function(e) {
		if (e.ctrlKey) {
			switch (e.key) {
				case ",":
					toggleFocus()
					break

				case "Enter":
					// terminal.echo("make")
					sendMsg("make")
					break

				case "0":
					// terminal.echo("make")
					sendMsg("remove")
					break

				case "\\":
					// terminal.echo("test")
					sendMsg("test")
					break
			}
		}
	})


	// focus switching shortcut
	let focus = "terminal"
	function toggleFocus() {
		switch (focus) {
			case "editor":
				focusOnTerminal()
				break
			case "terminal":
				focusOnEditor()
				break
		}

	}

	function focusOnTerminal() {
		terminal.focus()
		focus = "terminal"
	}

	function focusOnEditor() {
	    terminal.focus(false)
	    editor.focus();
	    focus="editor"
	}

	$("#terminal").focusin(()=>{focus="terminal"})
	$("#editor").focusin(()=>{focus="editor"})

	// shortcut to make
	// $(document).keypress("m",function(e) {
	// 	if(e.ctrlKey){
	// 		sendMsg("make")
	// 	}
	// })


	var editor = ace.edit("editor");
	editor.session.setMode("ace/mode/python")
	// will later refer to terminal...
	var terminal = null

	// CSS UI functions
	function swapMain() {
		$("#graph").css("order", +$("#graph").css("order") ? "0" : "1")
		$("#editor").css("order", +$("#editor").css("order") ? "0" : "1")
	}

	function swapTerm() {
		$("#main-col").css("flex-direction", $("#main-col").css("flex-direction") == "column" ? "column-reverse" : "column")
		
	}

	const versionNum = '1.0.0';
	const versionTag = 'NodeWars:' + versionNum;
	const confirmationPhrase = 'Welcome to NodeWars';
	const logo = " _  _         _   __      __           \n" +
	 			 "| \\| |___  __| |__\\ \\    / /_ _ _ _ ___\n" +
	 			 "| .` / _ \\/ _` / -_) \\/\\/ / _` | '_(_-<\n" +
	  			 "|_|\\_\\___/\\__,_\\___|\\_/\\_/\\__,_|_| /__/\n" 


	const introMessage = "Check out https://help.nodewars.net for more info"
	// const helpFiles = [
	const helpFiles = ["help_docs.json"]
	// const uiHelpFile = "./uihelp_docs.json"
	let helpObj
	let cmdList

	for (let file of helpFiles) {
		console.log("file",file)
		$.getJSON(file, function(json) {
			console.log("Loaded", file, "as JSON")
		    // console.log(json); // this will show the info it in firebug console
		    helpObj = json
		    cmdList = makeCmdList(json)
		});
	}

	function makeCmdList(json) {
		let txt = "\nAvailable commands: "
		const cmds = []
		for (let cmd of json) {
			cmds.push(cmd.keywords[0])
		}
		txt += cmds.join(', ')
		txt += "\nhelp (cmd) to get more info.\n"
		return txt
	}

	function prettifyCommand(cmd) {
		let recordIndex = -1
		let retStr
		console.log("help object", helpObj[1])
		for (let i = 0; i < helpObj.length; i++) {
			if (helpObj[i].keywords.indexOf(cmd) > -1) {
				recordIndex = i 
				break
			}
		}
		if (recordIndex > -1) {
			retStr = "Command: " + helpObj[recordIndex].keywords.join(', ') + "\n" + 
					 "Usage: " + helpObj[recordIndex].usage + "\n" +
					 "----------\n" + helpObj[recordIndex].shortDesc + "\n"
		} 

		return retStr
	}

	function parseGraphState(msg) {

		const newState = JSON.parse(msg.data)
		console.log('updateGraph called with state:', newState)
		// console.log("graphViz before arrayifyNodeMap:", newState.graphViz)
		// let graphViz = arrayifyNodeMap(newState.graphViz)
		// console.log("graphViz after arrayifyNodeMap:", newState.graphViz)
		// if (msg.type == "initGraphState") {
		// 	// console.log("initing with graphViz", graphViz)
		// 	initGraph(graphViz)
		// } 
		graphViz.update(newState)
		graphViz.draw()
	}

	function updateLanguage(newLang) {
		editor.session.setMode("ace/mode/" + newLang.toLowerCase())
	}

	function updateEditorContent(newContent) {
		editor.session.setValue(newContent)
		editor.navigateFileEnd()
		focusOnEditor()
	}

	function updateOutput(newOutput) {
		$("#output").text(newOutput)
	}


	let userPrompt = "nodewars>"
	function parseServerMessages(e) {
		const msg = JSON.parse(e.data);
		console.log("received: ", msg)
		switch (msg.sender) {
			case "pseudoServer":
				// write to terminal
				if (msg.type == "")
					terminal.echo(msg.data)
				else if (msg.type == "dialogue"){
					// TODO seems like terminal.read isn't behaving right, look at code and check if it has anything to do with being on dev branch
					terminal.echo(msg.data)
					terminal.read("", function(r){
						sendMsg(r)
					})
				}
				else
					terminal.echo(msg.type + ": " + msg.data)
				break

			case "server":
				switch(msg.type) {
					case "alertFlash":
						graphViz.alertFlash(msg.data)
						break

					case "pauseTerm":
						terminal.pause()
						break
					
					case "unpauseTerm":
						terminal.resume()
						break

					case "graphReset":
						graphViz.reset()
						break

					case "graphState": 
						parseGraphState(msg)
						break

					case "resultState":
						updateOutput(msg.data)
						break

					case "scoreState":
						const teams = JSON.parse(msg.data)
						graphViz.updateScore(teams) 
						break

					case "languageState":
						updateLanguage(msg.data)
						break

					case "editorState":
						updateEditorContent(msg.data)
						break

					case "promptState":
						terminal.set_prompt(msg.data)
						break
					
					case "teamState":
						if (msg.data == "")
							$("#team-flag").css("background-color", "black")
						else {
							$("#team-flag").css("background-color", msg.data)
						}
						break

					default:
						console.log("(server) ", msg.type, ":", msg.data)
						break
				}
				break

			default:
				console.log("unknown message sender,", e)
		}
	}

	let ws_protocol = 'ws://'
	if (location.protocol == 'https:')
		ws_protocol = 'wss://'

	const ws = new WebSocket(ws_protocol + window.location.host + '/ws');


	function handshake() {
		console.log('>', versionTag)
		ws.send(versionTag)
	}

	ws.addEventListener('open', () => {
				handshake()
			});

	ws.addEventListener('message', (e)=>{
		if (e.data == confirmationPhrase) {
			console.log('> Handshake succesful <')

			// turn on normal message parsing
			ws.addEventListener('message', parseServerMessages);

			// handle server terminating connection
			ws.addEventListener('close', (d) => {console.log("server severed connection:", d)});
			return
		}
		console.log('Server said:', e.data)
		throw "Error: failed to negotiate handshake with server"
		ws.close()
	}, { once: true });

	function sendMsg(input) {
		const cmd = input.split(" ")[0]
		let message
		
		// If this command requires code be sent with it
		if (codeCmds.indexOf(cmd) != -1) {
			// First set the STDIN
			// TODO fix this hacky nonsense
			// message = JSON.stringify({
			// 	type: "playerCmd",
			// 	data: "setStdinFromTheFrontEndButNotARealCommand " + $("#stdin").val()
			// })
			
			// ws.send(message)
			if (cmd == "test")
				input = "test " + $("#stdin").val()

			// now send the code
			console.log("sending code along too")
			message = JSON.stringify({
				type: "playerCmd",
				data: input,
				code: editor.getValue()
			})
		} else {
			// console.log("sending just command")
			message = JSON.stringify({
				type: "playerCmd",
				data: input
			})
		}

		console.log("sending message:", message)

		ws.send(message)
	}


	// codeCmds are playerCmds that need to submit the codebox to the messenger.
	// codeBox content is only submitted with this type of command
	const codeCmds = [
		"make", "makemod",
		"rm", "remove",
		"test",
		"ref", "refac"
	]

	//jquery terminal stuff
	jQuery(function($, term) {
		terminal = term;
	    $('#terminal').terminal({
	    	// editor font size adjust
	    	// editor theme change (w/ list) TODO
	    	// flash: function(color){
	    	// 	alertFlash(color)
	    	// },

	    	help: function(cmd) {
	    		if (!cmd) {
	    			this.echo(cmdList)
	    		} else {
	    			const txt = prettifyCommand(cmd)
					// console.log("HELP",txt)
					if (txt){
						this.echo(txt)
					} else {
						this.echo("error: help: Unknown command '" + cmd + "'")
					}
	    		}
	    	},
	    	// swap disabled cause if fucks with resizability...
	        // swap: function(a) {
	        // 	switch (a) {
	        // 		case "main":
		       //  		swapMain()
		       //  		break
		       //  	case "term":
		       //  		swapTerm()
		       //  		break
		       //  	default:
		       //  		swapTerm()
		       //  		break
	        // 	}
	        // },

	        // fontsize: function(a) {
	        // 	// buggy
	        // 	// $(".terminal, .cmd, .terminal .terminal-output div div, .cmd .prompt").css("font-size", a)
	        // },

	        color: function(a, b) {
	        	switch (a){
	        		case "graph":
	        		$("#graph").css("background-color", b)
	        		break

	        		case "edit":
	        		$("#editor").css("background-color", b)
	        		break

	        		case "term":
	        		$("terminal").css("background-color", b)
	        		break

	        		default:
	        		this.echo("'" + a +"' is not a valid element, \ntry 'term', 'graph', or 'edit'")
	        	}
	        },

	        ed: function() {
	        	this.focus(false)
	        	editor.focus()
	        },

	        vim: function(a) {
	        	switch (a) {
	        		case "on":
	                    // console.log(editor.getKeyboardHandler())
	        			editor.setKeyboardHandler("ace/keyboard/vim")
	        			this.echo("Vim mode on")
	        			break
	        		case "off":
	        			editor.setKeyboardHandler(null)
	        			this.echo("Vim mode off")
	                    // console.log(editor.getKeyboardHandler())
	        			break
	        		default:
	        			this.echo("invalid argument")
	        	}
	        },

	    }, {
	    	pauseEvents: false,
	    	fontSize:40,
	        greetings: "Welcome to\n" + logo + "\nv" + versionNum + "\n" + introMessage,
	        // checkArity: don't check argument length 
	        checkArity: false,
	        prompt: "",
	        // keydown: disable build in shortcuts
			keydown: false,
	        // exit: disable crtl-D exit of terminal
	        exit: false,
	        prompt: function() {
	        	// console.log(userPrompt)
	        	// setTimeout(()=>{terminal.set_prompt(userPrompt)}, 1000)
	        },
	        onInit: function() {
	        	terminal = this

	        	// set this.helpText to parsed json of 
	        },
	        onCommandNotFound: a => {
	        	sendMsg(a)
	        },
	      
	    });
	});
	
	// hacky way to allow quotes in our command line
	$.terminal.unclosed_strings = () => false

	// function prettifyCommands(json) {
	// 	let text = "List of available commands:\n" 

	// 	var cmdMaxLen = 0
	// 	var aliasMaxLen = 0

	// 	for (let cmd of json) {
	// 		// console.log(cmd)
	// 		if (cmd.keywords[0].length > cmdMaxLen)
	// 			cmdMaxLen = cmd.keywords[0].length

	// 		const aliasLength = cmd.keywords.join(', ').length
	// 		console.log("length for", cmd.keywords.join(', '), "is", cmd.keywords.join(', ').length)
	// 		if (aliasLength > cmdMaxLen)
	// 			aliasMaxLen = aliasLength
	// 	}

	// 	for (let cmd of json) {
	// 		let leftSide = cmd.keywords[0]
	// 		let rightSide = "("+ cmd.keywords.join(', ') + ")"

	// 		for (let i = 0; i < cmdMaxLen - cmd.keywords[0].length; i++) {
	// 			leftSide += " "
	// 		}
	// 		for (let j = 0; j < aliasMaxLen - cmd.keywords.join(', ').length+2; j++) {
	// 			rightSide = " " + rightSide
	// 		}
	// 		text += leftSide + "   -   " + rightSide + "\n"
	// 	}


	// 	text += "help (command) for more info."
	// 	return text
	// }

// })

</script>
</body>
</html>
