<!DOCTYPE html>
<html>
<head>
	<title>Basic Handshake</title>
	<script src="https://unpkg.com/vue"></script>
</head>
<body>
<p style="margin: 10px">
	NodeWars Handshake
</p>
<div id="app" style="margin:10px">
	<input autofocus="true" id="msgBox" v-model="message" @keyup.enter="sendMsg" >
	<select v-model="msgType" size="5" @click="reFocus">
		<option value="teamChat">teamChat</option>
		<option value="allChat">allChat</option>
		<option value="teamJoin">teamJoin</option>
		<option value="nodeConnect">nodeConnect</option>
		<option value="stateRequest">stateRequest</option>
	</select>
	<div v-bind:style="{ width: '30px', height:'30px', border:'2px solid black', backgroundColor: teamColor }">
	</div>

</div>

<script>
'use strict';
const versionNum = '0.0.0.1';
const versionTag = 'NodeWars:' + versionNum;
const confirmationPhrase = 'Welcome to NodeWars';



// Minimal Vue Stuff
new Vue({
	el: '#app',

	data: function() {
		return {
			message: '',
			msgType: 'teamJoin',
			ws: null,
			teamColor: 'white',
			gameState: null

		}
	},

	methods: {
		sendMsg: function () {
			const message = JSON.stringify({
				type: this.msgType,
				data: this.message
			})
			this.message = ''
			// console.log("sending", message, "to socket:", ws)
			this.ws.send(message)
		},

		handshake: function() {
			console.log('>', versionTag)
			this.ws.send(versionTag)
		},

		reFocus: function() {
			msgBox.focus()
		},

		updateState: function(newState) {
			this.gameState=newState;
			console.log("> State updated <", this.gameState);
		},

		parseServerMessages: function(e) {
			const message = JSON.parse(e.data);
			switch (message.type) {
				case "teamAssign":
					this.teamColor = message.data
					break
				case "teamChat":
					console.log("("+this.teamColor+")", message.sender + ":", message.data)
					break
				case "allChat":
					console.log("(all)", message.sender + ":", message.data)
					break
				case "error":
					console.log("> server error < \n", message.data)
					break
				case "gameState":
					this.updateState(JSON.parse(message.data))
					break

			}
		}
	},

	created: function () {		
		this.ws = new WebSocket('ws://' + window.location.host + '/ws');

		// Send handshake once socket is open
		this.ws.addEventListener('open', () => {
			this.handshake()
		});

		// Debugging purposes
		this.ws.addEventListener('message', (e) => {
			// console.log('<', e.data)
		});

		// Confirm receipt of correct version number (one time listener)
		this.ws.addEventListener('message', (e)=>{
			if (e.data == confirmationPhrase)
				console.log('> Handshake succesful <')

				// turn on normal message parsing
				this.ws.addEventListener('message', this.parseServerMessages);
				return
			console.log('Server said:', e.data)
			throw "Error: failed to negotiate handshake with server"
			this.ws.close()
		}, { once: true });
	}
})


</script>
</body>
</html>