<!DOCTYPE html>
<html>
<head>
	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon"> 
	<title>NodeWars SuperMegaAlpha</title>
	<script src="libs/d3.js"></script>
	<script src="libs/jquery.terminal/js/jquery-1.7.1.min.js"></script>
    <script src="libs/jquery.terminal/js/jquery.terminal.min.js"></script>
    <!-- <script src="https://rawgit.com/RickStrahl/jquery-resizable/master/src/jquery-resizable.js"></script> -->
    <script src="https://unpkg.com/split.js/split.min.js"></script>
    <link href="libs/jquery.terminal/css/jquery.terminal.css" rel="stylesheet"/>
    <script src="libs/ace-builds/src/ace.js" type="text/javascript" charset="utf-8">
</script>

  <style>

	#main-col {
		position:absolute;
		top:0;
		bottom:0;
		left:0;
		right:0;

		display:flex;
		flex-direction: column-reverse;
		flex-wrap: nowrap;
	}

	.gutter {
		background-color: grey;
	}

	#main-row {
		display:flex;
		flex-grow: 20;
		/*order:0;*/
		/*flex:1 1 auto;*/
		flex-direction: row;
		flex-wrap: nowrap;
	}

	#graph {
		/*order:0;*/
		flex-grow:1;
		background-color: beige;
		overflow-y: auto;
	}

	#editor {
		/*order:1;*/
		flex-grow:2;
		background-color: lightgrey;
	}

	#team-flag {
		/*order:1;*/
		width:100%;
		height:8px;
		background-color: black
	}

	#terminal {
		/*order:0;*/
		flex-grow:10;
		height: 100%;
		width: 100%;
	}

	.terminal, .cmd, .terminal .terminal-output div div, .cmd .prompt {
	    font-size: 18px;
	    line-height: 22px;
	}

	/*map styling*/

	.node-main, .node-backing {
		stroke: black;
		stroke-width: 2;
		fill: white
	}

	.traffic {
  		stroke-width:3;
  	}

  	.player-connected {
  		stroke-width:6;
  	}

  	.node-poe{
	  animation-duration: 1.3s;
	  animation-name: glowPulse;
	  animation-iteration-count: infinite;
	  animation-direction: alternate;
	  -webkit-animation-timing-function: linear; /* Safari 4.0 - 8.0 */
      animation-timing-function: linear;
	}
  	

  	line.traffic {
  		stroke-width:4;
  	}

	@keyframes glowPulse {
	  from {
	  	fill-opacity:.4;
	    /*fill-opacity:1;*/
	  }

	  to {
	  	fill-opacity:.8;
	  }
}

  </style>
</head>
<body>

<div id="main-col">
	<div id="main-row">
		<div id="graph"></div>
		<div id="editor"></div>
	</div>
	<!-- <div id="splitter-horizontal"></div> -->
	<!-- <div id="term-column"> -->
		
		<div id="terminal"></div>
		<div id="team-flag"></div>
	<!-- </div> -->
</div>


<script src="d3app.js"></script>

<script>
'use strict';

const nodeMap = new NWGraph('#graph')
Split(['#main-row', '#terminal'], {
	direction: 'vertical',
    elementStyle: function (dimension, size, gutterSize) {
        return {
            'flex-basis': 'calc(' + size + '% - ' + gutterSize + 'px)'
        }
    },
    gutterStyle: function (dimension, gutterSize) {
        return {
            'flex-basis':  gutterSize + 'px'
        }
    }
})


// focus switching shortcut
let focus = "terminal"
$(document).keypress("`",function(e) {
	if(e.ctrlKey){
		switch (focus) {
			case "editor":
				terminal.focus()
				focus = "terminal"
				break
			case "terminal":
			    terminal.focus(false)
			    editor.focus();
			    focus="editor"
				break
		}
	  }
});
$("#terminal").focusin(()=>{focus="terminal"})
$("#editor").focusin(()=>{focus="editor"})

// shortcut to make
// $(document).keypress("m",function(e) {
// 	if(e.ctrlKey){
// 		sendMsg("make")
// 	}
// })


var editor = ace.edit("editor");
editor.session.setMode("ace/mode/python")
// will later refer to terminal...
var terminal = null

// CSS UI functions
function swapMain() {
	$("#graph").css("order", +$("#graph").css("order") ? "0" : "1")
	$("#editor").css("order", +$("#editor").css("order") ? "0" : "1")
}

function swapTerm() {
	$("#main-col").css("flex-direction", $("#main-col").css("flex-direction") == "column" ? "column-reverse" : "column")
	
}

const versionNum = '0.0.0.1';
const versionTag = 'NodeWars:' + versionNum;
const confirmationPhrase = 'Welcome to NodeWars';
const logo = " _  _         _   __      __           \n" +
 			 "| \\| |___  __| |__\\ \\    / /_ _ _ _ ___\n" +
 			 "| .` / _ \\/ _` / -_) \\/\\/ / _` | '_(_-<\n" +
  			 "|_|\\_\\___/\\__,_\\___|\\_/\\_/\\__,_|_| /__/\n" 


// const helpFiles = [
const helpFiles = ["help_docs.json"]
// const uiHelpFile = "./uihelp_docs.json"
let helpObj
let cmdList

for (let file of helpFiles) {
	console.log("file",file)
	$.getJSON(file, function(json) {
		console.log("Loaded", file, "as JSON")
	    // console.log(json); // this will show the info it in firebug console
	    helpObj = json
	    cmdList = makeCmdList(json)
	});
}

function makeCmdList(json) {
	let txt = "\nAvailable commands: "
	const cmds = []
	for (let cmd of json) {
		cmds.push(cmd.keywords[0])
	}
	txt += cmds.join(', ')
	txt += "\nhelp (cmd) to get more info.\n"
	return txt
}

function prettifyCommand(cmd) {
	let recordIndex = -1
	let retStr
	console.log("help object", helpObj[1])
	for (let i = 0; i < helpObj.length; i++) {
		if (helpObj[i].keywords.indexOf(cmd) > -1) {
			recordIndex = i 
			break
		}
	}
	if (recordIndex > -1) {
		retStr = "Command: " + helpObj[recordIndex].keywords.join(', ') + "\n" + 
				 "Usage: " + helpObj[recordIndex].usage + "\n" +
				 "----------\n" + helpObj[recordIndex].shortDesc + "\n"
	} 

	return retStr
}

function parseGraphState(msg) {

	const newState = JSON.parse(msg.data)
	console.log('updateGraph called with state:', newState)
	// console.log("nodeMap before arrayifyNodeMap:", newState.nodeMap)
	// let nodeMap = arrayifyNodeMap(newState.nodeMap)
	// console.log("nodeMap after arrayifyNodeMap:", newState.nodeMap)
	// if (msg.type == "initGraphState") {
	// 	// console.log("initing with nodemap", nodeMap)
	// 	initGraph(nodeMap)
	// } 
	nodeMap.update(newState)
	nodeMap.draw()
}

function updateLanguage(newLang) {
	editor.session.setMode("ace/mode/" + newLang.toLowerCase())
}

function updateEditorContent(newContent) {
	editor.session.setValue(newContent)
}


let userPrompt = "nodewars>"
function parseServerMessages(e) {
	const msg = JSON.parse(e.data);
	switch (msg.sender) {
		case "pseudoServer":
			
			// if server asks for confirmation, pose a question to user and send the response... 
			if (msg.type == "confirmation") {
				terminal.read(msg.data, (d) => {
					sendMsg(d)
				})
				break
			}
			// write to terminal
			let txt = msg.type + " " + msg.data
			// sometimes msg.type is blank, so trim
			txt = txt.trim()
			// trim lost us our nice formatting, so add a newline
			terminal.echo(txt + "\n")			
			break

		case "server":
			switch(msg.type) {
				case "alertFlash":
					alertFlash(msg.data)
					break

				case "graphState": 
					parseGraphState(msg)
					

				case "initGraphState": 
					parseGraphState(msg)
					break

				case "languageState":
					updateLanguage(msg.data)
					break

				case "editorState":
					updateEditorContent(msg.data)
					break

				case "promptState":
					terminal.set_prompt(msg.data)
					break
				
				case "teamState":
					$("#team-flag").css("background-color", msg.data)

				default:
					console.log("(server) ", msg.type, ":", msg.data)
					break
			}
			break

		default:
			console.log("unknown message sender,", e)
	}
}

const ws = new WebSocket('ws://' + window.location.host + '/ws');


function handshake() {
	console.log('>', versionTag)
	ws.send(versionTag)
}

ws.addEventListener('open', () => {
			handshake()
		});

ws.addEventListener('message', (e)=>{
	if (e.data == confirmationPhrase) {
		console.log('> Handshake succesful <')

		// turn on normal message parsing
		ws.addEventListener('message', parseServerMessages);

		// handle server terminating connection
		ws.addEventListener('close', (d) => {console.log("server severed connection:", d)});
		return
	}
	console.log('Server said:', e.data)
	throw "Error: failed to negotiate handshake with server"
	ws.close()
}, { once: true });

function sendMsg(input) {
	const cmd = input.split(" ")[0]
	let message

	// console.log('index of cmd', cmd, ":" ,codeCmds.indexOf(cmd));
	if (codeCmds.indexOf(cmd) != -1) {
		console.log("sending code along too")
		message = JSON.stringify({
			type: "playerCmd",
			data: input,
			code: editor.getValue()
		})
	} else {
		// console.log("sending just command")
		message = JSON.stringify({
			type: "playerCmd",
			data: input
		})
	}

	console.log("sending message:", message)

	ws.send(message)
}


// codeCmds are playerCmds that need to submit the codebox to the messenger.
// codeBox content is only submitted with this type of command
const codeCmds = [
	"make", "makemod",
	"rm", "remove",
	"test",
	"ref", "refac"
]

//jquery terminal stuff
jQuery(function($, term) {
	terminal = term;
    $('#terminal').terminal({
    	// editor font size adjust
    	// editor theme change (w/ list) TODO
    	flash: function(color){
    		alertFlash(color)
    	},

    	help: function(cmd) {
    		if (!cmd) {
    			this.echo(cmdList)
    		} else {
    			const txt = prettifyCommand(cmd)
				console.log("HELP",txt)
				if (txt){
					this.echo(txt)
				} else {
					this.echo("error: help: Unknown command '" + cmd + "'")
				}
    		}
    	},
    	// swap disabled cause if fucks with resizability...
        // swap: function(a) {
        // 	switch (a) {
        // 		case "main":
	       //  		swapMain()
	       //  		break
	       //  	case "term":
	       //  		swapTerm()
	       //  		break
	       //  	default:
	       //  		swapTerm()
	       //  		break
        // 	}
        // },

        fontsize: function(a) {
        	// buggy
        	// $(".terminal, .cmd, .terminal .terminal-output div div, .cmd .prompt").css("font-size", a)
        },

        color: function(a, b) {
        	switch (a){
        		case "graph":
        		$("#graph").css("background-color", b)
        		break

        		case "edit":
        		$("#editor").css("background-color", b)
        		break

        		case "term":
        		$("terminal").css("background-color", b)
        		break

        		default:
        		this.echo("'" + a +"' is not a valid element, \ntry 'term', 'graph', or 'edit'")
        	}
        },

        ed: function() {
        	this.focus(false)
        	editor.focus()
        },

        vim: function(a) {
        	switch (a) {
        		case "on":
                    // console.log(editor.getKeyboardHandler())
        			editor.setKeyboardHandler("ace/keyboard/vim")
        			this.echo("Vim mode on")
        			break
        		case "off":
        			editor.setKeyboardHandler(null)
        			this.echo("Vim mode off")
                    // console.log(editor.getKeyboardHandler())
        			break
        		default:
        			this.echo("invalid argument")
        	}
        },

    }, {
    	fontSize:40,
        height: 100,
        greetings: "Welcome to\n" + logo + "\nv" + versionNum,
        checkArity: false,
        prompt: "",
        exit: false,
        prompt: function() {
        	// console.log(userPrompt)
        	// setTimeout(()=>{terminal.set_prompt(userPrompt)}, 1000)
        },
        onInit: function() {
        	terminal = this

        	// set this.helpText to parsed json of 
        },
        onCommandNotFound: a => {
        	sendMsg(a)
        },
      
    });
});

// function prettifyCommands(json) {
// 	let text = "List of available commands:\n" 

// 	var cmdMaxLen = 0
// 	var aliasMaxLen = 0

// 	for (let cmd of json) {
// 		// console.log(cmd)
// 		if (cmd.keywords[0].length > cmdMaxLen)
// 			cmdMaxLen = cmd.keywords[0].length

// 		const aliasLength = cmd.keywords.join(', ').length
// 		console.log("length for", cmd.keywords.join(', '), "is", cmd.keywords.join(', ').length)
// 		if (aliasLength > cmdMaxLen)
// 			aliasMaxLen = aliasLength
// 	}

// 	for (let cmd of json) {
// 		let leftSide = cmd.keywords[0]
// 		let rightSide = "("+ cmd.keywords.join(', ') + ")"

// 		for (let i = 0; i < cmdMaxLen - cmd.keywords[0].length; i++) {
// 			leftSide += " "
// 		}
// 		for (let j = 0; j < aliasMaxLen - cmd.keywords.join(', ').length+2; j++) {
// 			rightSide = " " + rightSide
// 		}
// 		text += leftSide + "   -   " + rightSide + "\n"
// 	}


// 	text += "help (command) for more info."
// 	return text
// }
</script>
</body>
</html>
